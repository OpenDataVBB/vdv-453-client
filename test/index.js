'use strict'

import {test} from 'tape'
import {readFileSync} from 'node:fs'
import {Readable} from 'node:stream'
import {strictEqual} from 'node:assert'
import {parseTags} from '../lib/xml-parser.js'
import {parseAusIstFahrt} from '../lib/parse-aus-istfahrt.js'
import {
	kBestaetigungZst,
} from '../lib/symbols.js'
import {runClient} from './util.js'

const LEITSTELLE = 'test-client'

const VBB_DDS_AUS_DATENABRUFENANTWORT_2024_04_11 = readFileSync(
	new URL('./vbb-dds-aus-datenabrufenantwort-2024-04-11.xml', import.meta.url).pathname,
)
const VBB_DDS_AUS_ISTFAHRT_2025_02_06_7610_08_8089188_210100__DB = JSON.parse(readFileSync(
	new URL('./vbb-dds-aus-istfahrt-2025-02-06-7610-08-8089188-210100_DB.json', import.meta.url).pathname,
))

test('XML -> JSON parsing works', async (t) => {
	const input = Readable.from(VBB_DDS_AUS_DATENABRUFENANTWORT_2024_04_11)
	const parser = parseTags(input, [
		{tag: 'Bestaetigung', preserve: true},
		{tag: 'WeitereDaten', preserve: true},
		{tag: 'AUSNachricht', preserve: true},
	])

	const els = []
	for await (const el of parser) {
		els.push(el)
	}

	t.equal(els[0].$name, 'Bestaetigung', 'els[0].$name')
	t.equal(els[1].$name, 'WeitereDaten', 'els[1].$name')
	t.equal(els[2].$name, 'AUSNachricht', 'els[2].$name')
	t.equal(els[2].$children.length, 2, 'els[2].children.length')
})

test('AUS IstFahrt parsing works', async (t) => {
	const ctx = {
		zst: '134-foo-bar',
	}
	const istFahrt = parseAusIstFahrt(
		VBB_DDS_AUS_ISTFAHRT_2025_02_06_7610_08_8089188_210100__DB,
		ctx,
	)

	t.equal(istFahrt[kBestaetigungZst], ctx.zst)
	t.deepEqual(istFahrt, {
		Zst: null,
		LinienID: '7610',
		LinienText: 'S7',
		RichtungsID: 'Ahrensfelde (S)#Berlin-Wannsee',
		RichtungsText: null,
		FahrtID: {
			FahrtBezeichner: '7610-08-8089188-210100#DB',
			Betriebstag: '2025-02-06',
		},
		FahrtStartEnde: {
			StartHaltID: null,
			Startzeit: null,
			EndHaltID: null,
			Endzeit: null,
		},
		Komplettfahrt: 'false',
		UmlaufID: null,
		PrognoseMoeglich: 'true',
		FaelltAus: 'true',
		FahrzeugTypID: null,
		ServiceAttributs: [],
		IstHalts: [
			{
				HaltID: 'ODEG_900170004',
				Abfahrtszeit: '2025-02-06T21:01:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '41',
				Einsteigeverbot: null,
				Ankunftszeit: null,
				IstAnkunftPrognose: null,
				AnkunftssteigText: null,
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900170003',
				Abfahrtszeit: '2025-02-06T21:03:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '2',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:03:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '2',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900170002',
				Abfahrtszeit: '2025-02-06T21:05:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '2',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:05:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '2',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900170001',
				Abfahrtszeit: '2025-02-06T21:07:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '2',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:06:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '2',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900170005',
				Abfahrtszeit: '2025-02-06T21:09:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '2',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:08:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '2',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900171003',
				Abfahrtszeit: '2025-02-06T21:11:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '2',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:10:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '2',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900171002',
				Abfahrtszeit: '2025-02-06T21:14:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '2',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:13:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '2',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900160004',
				Abfahrtszeit: '2025-02-06T21:16:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '2',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:16:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '2',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900160003',
				Abfahrtszeit: '2025-02-06T21:18:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '2',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:18:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '2',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900120003',
				Abfahrtszeit: '2025-02-06T21:21:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '6',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:20:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '6',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900120004',
				Abfahrtszeit: '2025-02-06T21:23:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '4',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:23:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '4',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900120005',
				Abfahrtszeit: '2025-02-06T21:26:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '11',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:25:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '11',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900100004',
				Abfahrtszeit: '2025-02-06T21:28:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '4',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:27:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '4',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900100003',
				Abfahrtszeit: '2025-02-06T21:30:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '4',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:29:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '4',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900100002',
				Abfahrtszeit: '2025-02-06T21:32:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '4',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:31:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '4',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900100001',
				Abfahrtszeit: '2025-02-06T21:34:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '6',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:33:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '6',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900003201',
				Abfahrtszeit: '2025-02-06T21:37:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '16',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:36:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '16',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900003102',
				Abfahrtszeit: '2025-02-06T21:39:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '4',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:39:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '4',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900003103',
				Abfahrtszeit: '2025-02-06T21:41:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '4',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:41:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '4',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900023201',
				Abfahrtszeit: '2025-02-06T21:43:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '6',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:43:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '6',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900024203',
				Abfahrtszeit: '2025-02-06T21:45:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '4',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:45:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '4',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900024101',
				Abfahrtszeit: '2025-02-06T21:47:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '8',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:47:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '8',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900024102',
				Abfahrtszeit: '2025-02-06T21:50:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '1',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:49:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '1',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900048101',
				Abfahrtszeit: '2025-02-06T21:53:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '1',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T21:52:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '1',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900052201',
				Abfahrtszeit: '2025-02-06T22:00:00+01:00',
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: '3',
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T22:00:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '3',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			},
			{
				HaltID: 'ODEG_900053301',
				Abfahrtszeit: null,
				IstAbfahrtPrognose: null,
				AbfahrtssteigText: null,
				Einsteigeverbot: null,
				Ankunftszeit: '2025-02-06T22:02:00+01:00',
				IstAnkunftPrognose: null,
				AnkunftssteigText: '1',
				Aussteigeverbot: null,
				Durchfahrt: null,
				Zusatzhalt: null,
				HinweisText: null,
			}
		]
	})
})

// todo
test.skip('todo', async (t) => {
	const {
		port,
		stop,
	} = await runClient({
		leitstelle: LEITSTELLE,
		endpoint: 'http://localhost:3000/',
	})

	// todo

	await stop()
})
